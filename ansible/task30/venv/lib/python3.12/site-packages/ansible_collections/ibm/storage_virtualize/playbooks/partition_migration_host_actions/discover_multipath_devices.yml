- name: Load VMD Output from File on Localhost
  hosts: localhost
  gather_facts: false
  tasks:


    - name: Read data provided by host_identification.yml playbook from file.
      ansible.builtin.slurp:
        src: "{{ file_name }}/matched_hosts.json"
      register: vmd_host_matched_list

    - name: Parse Output to read content.
      ansible.builtin.set_fact:
        host_matched_list_processed: "{{ vmd_host_matched_list['content'] | b64decode | from_json }}"

    - name: Extract FC inventory hostnames
      ansible.builtin.set_fact:
        vmd_host_matched_list_processed: >-
          {{
            host_matched_list_processed
            | selectattr('connection', 'equalto', 'iscsi')
            | map(attribute='inventory_hostname')
            | list
          }}

    - name: Mapping between inventory_hostname and iscsi_ips for iSCSI connections only
      ansible.builtin.set_fact:
        inv_iscsi_ip_map: >-
          {{
            dict(
              host_matched_list_processed
              | selectattr('connection', 'equalto', 'iscsi')
              | map(attribute='inventory_hostname')
              | zip(
                  host_matched_list_processed
                  | selectattr('connection', 'equalto', 'iscsi')
                  | map(attribute='iscsi_ips')
                )
            )
          }}

- name: Rescan and verify SCSI devices and multipath
  hosts: "{{ hostvars['localhost'].vmd_host_matched_list_processed | default([]) }}"
  serial: 1
  tasks:

    - name: Gather facts for all hosts.
      ansible.builtin.setup:
      register: system_info

    # Linux-specific (RHEL) tasks
    - name: Linux tasks
      when: system_info.ansible_facts.ansible_system == "Linux"
      block:

        - name: When ips are provide in inventory file for linux
          when:
            - hostvars[inventory_hostname] is defined
            - "'ansible_iscsi_ips' in hostvars[inventory_hostname]"
            - hostvars[inventory_hostname].ansible_iscsi_ips | length > 0
          block:

            - name: Discover and login iSCSI targets from inventory file
              ansible.builtin.shell: |
                iscsiadm -m discovery -t st -p "{{ item }}" -l
              register: iscsi_results
              changed_when: false
              # failed_when: iscsi_results.rc != 0
              ignore_errors: true
              loop: "{{ hostvars[inventory_hostname].ansible_iscsi_ips }}"
              loop_control:
                label: "{{ item }}"

            - name: Show iSCSI discovery results for inventory file entries
              ansible.builtin.debug:
                msg: |
                  RC: {{ item.rc }}
              loop: "{{ iscsi_results.results }}"

            - name: Relogin iSCSI session for inventory file
              when: rescan_flag == "yes"
              block:
                - name: Relogin iSCSI session if it's not active
                  ansible.builtin.shell: |
                    echo "Relogin: {{ item }}"
                    output=$(iscsiadm -m node -p {{ item }} -R 2>&1)
                    rc=$?
                    if [[ "$output" == *"No session found."* || $rc -ne 0 ]]; then
                      echo "No session found. Attempting discovery and login..."
                      iscsiadm -m discovery -t st -p {{ item }}
                      if iscsiadm -m discovery -t st -p {{ item }} -l; then
                        echo "Login successful for {{ item }}."
                      else
                          echo "Login failed for {{ item }}."
                          exit 1
                      fi
                    else
                        echo "Relogin successful for {{ item }}."
                    fi
                  register: relogin_result
                  loop: "{{ hostvars[inventory_hostname].ansible_iscsi_ips }}"
                  loop_control:
                    label: "{{ item }}"
                  changed_when: false
                  ignore_errors: true

                - name: Show iSCSI discovery results
                  ansible.builtin.debug:
                    msg: |
                      RC: {{ item.rc }}
                  loop: "{{ relogin_result.results }}"


        - name: When ips are fetch from portset for linux
          when: "'ansible_iscsi_ips' not in hostvars[inventory_hostname] or hostvars[inventory_hostname].ansible_iscsi_ips == []"
          block:

            - name: Set_fact for iscsi_ip
              ansible.builtin.set_fact:
                iscsi_ip_list: "{{ hostvars['localhost'].inv_iscsi_ip_map[inventory_hostname] }}"

            - name: Discover and login iSCSI targets
              ansible.builtin.shell: |
                iscsiadm -m discovery -t st -p "{{ item }}" -l
              register: iscsi_results
              changed_when: false
              # failed_when: iscsi_results.rc != 0
              ignore_errors: true
              loop: "{{ iscsi_ip_list }}"
              loop_control:
                label: "{{ item }}"

            - name: Show iSCSI discovery results
              ansible.builtin.debug:
                msg: |
                  RC: {{ item.rc }}
              loop: "{{ iscsi_results.results }}"

            - name: Relogin iSCSI session
              when: rescan_flag == "yes"
              block:
                - name: Relogin iSCSI session if it's not active
                  ansible.builtin.shell: |
                    echo "Relogin: {{ item }}"
                    output=$(iscsiadm -m node -p {{ item }} -R 2>&1)
                    rc=$?
                    if [[ "$output" == *"No session found."* || $rc -ne 0 ]]; then
                      echo "No session found. Attempting discovery and login..."
                      iscsiadm -m discovery -t st -p {{ item }}
                      if iscsiadm -m discovery -t st -p {{ item }} -l; then
                        echo "Login successful for {{ item }}."
                      else
                          echo "Login failed for {{ item }}."
                          exit 1
                      fi
                    else
                        echo "Relogin successful for {{ item }}."
                    fi
                  register: relogin_result
                  loop: "{{ iscsi_ip_list }}"
                  loop_control:
                    label: "{{ item }}"
                  changed_when: false
                  ignore_errors: true

                - name: Show iSCSI discovery results
                  ansible.builtin.debug:
                    msg: |
                      RC: {{ item.rc }}
                  loop: "{{ relogin_result.results }}"


    # Windows
    - name: Windows tasks
      when: system_info.ansible_facts.ansible_system == "Win32NT"
      block:

        - name: When IPs are provided in inventory file for Windows
          when:
            - hostvars[inventory_hostname] is defined
            - "'ansible_iscsi_ips' in hostvars[inventory_hostname]"
            - hostvars[inventory_hostname].ansible_iscsi_ips | length > 0
          block:

            - name: Ensure iSCSI Initiator Service is running
              ansible.windows.win_service:
                name: MSiSCSI
                start_mode: auto
                state: started

            - name: Add iSCSI Target Portals   # noqa: ignore-errors
              ansible.windows.win_shell: |
                New-IscsiTargetPortal -TargetPortalAddress {{ item }} -ErrorAction SilentlyContinue
              loop: "{{ hostvars[inventory_hostname].ansible_iscsi_ips }}"
              loop_control:
                label: "{{ item }}"
              ignore_errors: true

            - name: Discover and login iSCSI targets  # noqa: ignore-errors
              ansible.windows.win_shell: |
                $targets = Get-IscsiTarget | Where-Object { $_.IsConnected -eq $false }
                foreach ($target in $targets) {
                  Connect-IscsiTarget -NodeAddress $target.NodeAddress -IsPersistent $true -IsMultipathEnabled $true
                }
              register: iscsi_results
              changed_when: false
              ignore_errors: true

            - name: Show iSCSI discovery results
              ansible.builtin.debug:
                msg: |
                  RC: {{ iscsi_results.rc }}
                  Stdout: {{ iscsi_results.stdout }}
                  Stderr: {{ iscsi_results.stderr }}

            - name: Relogin iSCSI session if not active
              when: rescan_flag is defined and rescan_flag | lower == 'yes'
              block:

                - name: Check and relogin iSCSI targets
                  ansible.windows.win_shell: |
                    $ipList = "{{ hostvars[inventory_hostname].ansible_iscsi_ips | join(',') }}"
                    foreach ($ip in $ipList -split ',') {
                      $portal = $ip.Trim()
                      $targets = Get-IscsiTarget | Where-Object { $_.IsConnected -eq $false }
                      if ($targets.Count -gt 0) {
                        Write-Host "Relogin: $portal"
                        foreach ($target in $targets) {
                          try {
                            Connect-IscsiTarget -NodeAddress $target.NodeAddress -IsPersistent $true -IsMultipathEnabled $true
                            Write-Host "Login successful for $($target.NodeAddress)"
                          } catch {
                            Write-Host "Login failed for $($target.NodeAddress)"
                          }
                        }
                      } else {
                        Write-Host "All sessions already connected."
                      }
                    }
                  register: relogin_result
                  changed_when: false
                  ignore_errors: true

                - name: Show iSCSI relogin results
                  ansible.builtin.debug:
                    msg: |
                      RC: {{ relogin_result.rc }}
                      Stdout: {{ relogin_result.stdout }}
                      Stderr: {{ relogin_result.stderr }}


        - name: When ips are fetch from portset for Windows
          when: "'ansible_iscsi_ips' not in hostvars[inventory_hostname] or hostvars[inventory_hostname].ansible_iscsi_ips == []"
          block:

            - name: Set_fact for iscsi_ip
              ansible.builtin.set_fact:
                iscsi_ip_list: "{{ hostvars['localhost'].inv_iscsi_ip_map[inventory_hostname] }}"

            - name: Ensure iSCSI Initiator Service is running
              ansible.windows.win_service:
                name: MSiSCSI
                start_mode: auto
                state: started

            - name: Add iSCSI Target Portals  # noqa: ignore-errors
              ansible.windows.win_shell: |
                New-IscsiTargetPortal -TargetPortalAddress {{ item }} -ErrorAction SilentlyContinue
              loop: "{{ iscsi_ip_list }}"
              loop_control:
                label: "{{ item }}"
              ignore_errors: true

            - name: Discover and login iSCSI targets  # noqa: ignore-errors
              ansible.windows.win_shell: |
                $targets = Get-IscsiTarget | Where-Object { $_.IsConnected -eq $false }
                foreach ($target in $targets) {
                  Connect-IscsiTarget -NodeAddress $target.NodeAddress -IsPersistent $true -IsMultipathEnabled $true
                }
              register: iscsi_results
              changed_when: false
              ignore_errors: true

            - name: Show iSCSI discovery results
              ansible.builtin.debug:
                msg: |
                  RC: {{ iscsi_results.rc }}
                  Stdout: {{ iscsi_results.stdout }}
                  Stderr: {{ iscsi_results.stderr }}

            - name: Relogin iSCSI session if not active
              when: rescan_flag is defined and rescan_flag | lower == 'yes'
              block:

                - name: Check and relogin iSCSI targets
                  ansible.windows.win_shell: |
                    $ipList = "{{ iscsi_ip_list | join(',') }}"
                    foreach ($ip in $ipList -split ',') {
                      $portal = $ip.Trim()
                      $targets = Get-IscsiTarget | Where-Object { $_.IsConnected -eq $false }
                      if ($targets.Count -gt 0) {
                        Write-Host "Relogin: $portal"
                        foreach ($target in $targets) {
                          try {
                            Connect-IscsiTarget -NodeAddress $target.NodeAddress -IsPersistent $true -IsMultipathEnabled $true
                            Write-Host "Login successful for $($target.NodeAddress)"
                          } catch {
                            Write-Host "Login failed for $($target.NodeAddress)"
                          }
                        }
                      } else {
                        Write-Host "All sessions already connected."
                      }
                    }
                  register: relogin_result
                  changed_when: false
                  ignore_errors: true

                - name: Show iSCSI relogin results
                  ansible.builtin.debug:
                    msg: |
                      RC: {{ relogin_result.rc }}
                      Stdout: {{ relogin_result.stdout }}
                      Stderr: {{ relogin_result.stderr }}


    - name: Other OS tasks
      when: system_info.ansible_facts.ansible_system == "Other OS"
      block:
        - name: Define task
          ansible.builtin.debug:
            msg: Write your code block here
          # Please add OS specific tasks to rescan multipath, refer to following blocks
