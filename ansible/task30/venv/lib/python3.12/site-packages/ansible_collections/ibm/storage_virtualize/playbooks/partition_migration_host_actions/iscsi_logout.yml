- name: Load VMD Output from File on Localhost
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Read data provided by host_identification.yml playbook from file.
      ansible.builtin.slurp:
        src: "{{ file_name }}/matched_hosts_source.json"
      register: vmd_host_matched_list

    - name: Parse Output to read content.
      ansible.builtin.set_fact:
        host_matched_list_processed: "{{ vmd_host_matched_list['content'] | b64decode | from_json }}"

    - name: Extract FC inventory hostname
      ansible.builtin.set_fact:
        vmd_host_matched_list_processed: >-
          {{
            host_matched_list_processed
            | selectattr('connection', 'equalto', 'iscsi')
            | map(attribute='inventory_hostname')
            | list
          }}

    - name: Mapping between inventory_hostname and iscsi_ips
      ansible.builtin.set_fact:
        inv_iscsi_ip_map: >-
          {{
            dict(
              host_matched_list_processed | map(attribute='inventory_hostname') |
              zip(host_matched_list_processed | map(attribute='iscsi_ips'))
            )
          }}

- name: Rescan and verify SCSI devices and multipath
  hosts: "{{ hostvars['localhost'].vmd_host_matched_list_processed | default([]) }}"
  serial: 1
  tasks:

    - name: Set_fact for iscsi_ip
      ansible.builtin.set_fact:
        iscsi_ip_list: "{{ hostvars['localhost'].inv_iscsi_ip_map[inventory_hostname] }}"

    - name: Gather facts for all hosts.
      ansible.builtin.setup:
      register: system_info

    # Linux-specific (RHEL) tasks
    - name: Linux tasks
      when: system_info.ansible_facts.ansible_system == "Linux"
      block:

        - name: Logout iSCSI sessions by target IP on linux
          ansible.builtin.shell: |
            iscsiadm -m node -p "{{ item }}" -u
          register: iscsi_results
          changed_when: false
          # failed_when: iscsi_results.rc != 0
          ignore_errors: true
          loop: "{{ iscsi_ip_list }}"
          loop_control:
            label: "{{ item }}"

    # Windows
    - name: Windows tasks
      when: system_info.ansible_facts.ansible_system == "Win32NT"
      block:

        - name: Logout iSCSI sessions by target IP on Windows
          ansible.windows.win_shell: |
            $target_ip = "{{ item }}"
            $sessions = Get-IscsiSession | Where-Object { $_.TargetPortalAddress -eq $target_ip }

            if ($sessions) {
                foreach ($session in $sessions) {
                    Disconnect-IscsiTarget -SessionIdentifier $session.SessionIdentifier -Confirm:$false
                    Write-Host "Logged out from $($session.TargetNodeName) at $target_ip"
                }
            } else {
                Write-Host "No active sessions found for $target_ip"
            }
          loop: "{{ iscsi_ip_list }}"
          loop_control:
            label: "{{ item }}"
          register: iscsi_logout_result
          changed_when: false
          ignore_errors: true
